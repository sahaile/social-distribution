<!-- profile.html -->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>User Profile</title>
    <!-- Title will be updated by JS -->
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/static/css/ui.css">
    <style>
      .container {
        max-width: 700px;
        margin: 20px auto;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 30px;
      }
      .profile-header {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 15px;
        text-align: center;
        padding-bottom: 20px;
        border-bottom: 1px solid #eee;
        width: 100%;
      }
      .profile-header img {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background-color: #f0f0f0; /* Placeholder color */
      }
      .profile-display-name {
        font-size: 24px;
        font-weight: bold;
        min-height: 30px; /* Prevent layout shift while loading */
      }
      .friend-badge {
        background-color: #e0f2fe;
        color: #0c546e;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
        margin-left: 10px;
        display: inline-block;
        vertical-align: middle;
      }
      /* CSS for proper markdown rendering */
      .entry-content p {
        margin: 0 0 1em 0;
        line-height: 1.5;
        white-space: pre-line;
      }
      .entry-content p:last-child {
        margin-bottom: 0;
      }
      .tweet-list {
        display: flex;
        flex-direction: column;
        gap: 25px;
        width: 100%;
      }
      .visually-hidden {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
      }
    </style>
  </head>
  <body>
    <div class="container">
        <a href="/" style="text-decoration: none; display: inline-block; margin-bottom: 20px; background: #f0f0f0; padding: 10px 15px; border-radius: 8px; color: #333; font-weight: 600;">&larr; Back to Main Page</a>
      <!-- Profile Header - will be populated by JS -->
      <header class="profile-header" id="profile-header-container">
        <img id="profile-pic" src="/profile.jpg" alt="Profile Picture">
        <div id="profile-name-container" class="profile-display-name">
          Loading...
        </div>
        <div class="profile-stats" style="margin-top: 15px; display: flex; gap: 15px; font-size: 14px;">
          <a href="#" id="following-link" style="color: #333; text-decoration: none;">
            <strong id="following-count">0</strong> Following
          </a>
          <a href="#" id="followers-link" style="color: #333; text-decoration: none;">
            <strong id="followers-count">0</strong> Followers
          </a>
        </div>

        <!-- GitHub link will be on the second row -->
        <a href="https://github.com/yourname" class="github-link" target="_blank" style="margin-top: 10px; display: inline-block;">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="#24292f" style="margin-right:3px;">
            <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49C3.73 14.09 3.28 12.81 3.28 12.81c-.36-.92-.88-1.16-.88-1.16-.72-.49.05-.48.05-.48.8.06 1.22.83 1.22.83.71 1.22 1.87.87 2.33.66.07-.52.28-.87.51-1.07-2.22-.25-4.56-1.11-4.56-4.93 0-1.09.39-1.98 1.03-2.68-.1-.25-.45-1.27.1-2.65 0 0 .84-.27 2.75 1.02A9.56 9.56 0 018 4.43c.85.004 1.71.12 2.51.35 1.9-1.29 2.74-1.02 2.74-1.02.55 1.38.2 2.4.1 2.65.64.7 1.03 1.59 1.03 2.68 0 3.83-2.34 4.68-4.57 4.92.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.19 0 .21.15.46.55.38C13.71 14.53 16 11.54 16 8c0-4.42-3.58-8-8-8z"></path>
          </svg>
          yourname
        </a>
      </header>

      <!-- Entries Feed - still rendered by server -->
      <main class="tweet-list">
        {% for entry in entries %}
        <article class="tweet">
          <h2 class="visually-hidden">
            Tweet by {{ entry.author.displayName }} on {{
            entry.published|date:"M d, Y" }}
          </h2>
          <div style="display: flex; align-items: center; gap: 10px">
            <strong>{{ entry.author.displayName }}</strong>
            <span style="font-size: 13px; color: #aaa">
              â€¢ {{ entry.published|date:"M d, Y" }}
            </span>
          </div>
          <div style="margin: 10px 0 6px 0">
            {% if entry.title %}
            <div style="font-weight: 600">{{ entry.title }}</div>
            {% endif %}
            <div class="entry-content" data-content-type="{{ entry.content_type }}" data-content="{{ entry.content }}"></div>
          </div>
          <div style="font-size: 13px; color: #bbb">
            Visibility: {{ entry.get_visibility_display }}
          </div>
        </article>
        {% empty %}
        <div style="color: #999; text-align: center; padding: 40px">
          This user has no visible entries.
        </div>
        {% endfor %}
      </main>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
      const pathParts = window.location.pathname.split("/");
      const authorSerial = pathParts[2];

      const profilePic = document.getElementById("profile-pic");
      const nameContainer = document.getElementById("profile-name-container");
      const headerContainer = document.getElementById("profile-header-container");

      fetch(`/api/authors/${authorSerial}/`)
        .then((res) => {
          if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
          return res.json();
        })
        .then((author) => {
          if (!author) return;

          const authorId = author.id || author.serial || author.uuid || "";

          document.getElementById('following-count').textContent = author.following_count ?? 0;
          document.getElementById('followers-count').textContent = author.followers_count ?? 0;
          document.getElementById('following-link').href = `/authors/${authorSerial}/following/`;
          document.getElementById('followers-link').href = `/authors/${authorSerial}/followers/`;

        
          nameContainer.textContent = author.displayName || "Unnamed User";
          
          // Update profile image with error handling
          if (author.profileImage) {
            profilePic.src = author.profileImage;
            profilePic.onerror = function() {
              this.src = "/static/images/defaultprofile.webp";
            };
          } else {
            profilePic.src = "/static/images/defaultprofile.webp";
          }
          
          if (author.github) {
            let ghLink = author.github;
            if (!ghLink.startsWith('http')) ghLink = 'https://github.com/' + ghLink;
            const githubLinkElement = document.querySelector('.github-link');
            githubLinkElement.href = ghLink;
            // Extract just the username for the link text
            githubLinkElement.childNodes[2].nodeValue = ' ' + author.github.split('/').pop();
          }

          // Append friend badge if is_friend true
          if (author.is_friend) {
            const friendBadge = document.createElement("span");
            friendBadge.className = "friend-badge";
            friendBadge.textContent = "Friends";
            nameContainer.appendChild(friendBadge);
          }
        })
        .catch((err) => {
          headerContainer.innerHTML = '<p style="color: red;">Failed to load profile.</p>';
          console.error(err);
        });
    });
    </script>
    
    <script src="/static/purify.min.js"></script>
    <script type="module">
      import { generateCommonmarkHtml } from '/static/renderer.min.js';
      
      // Process markdown content for entries on page load
      document.addEventListener('DOMContentLoaded', () => {
        const entryContentElements = document.querySelectorAll('.entry-content');
        
        entryContentElements.forEach(element => {
          const contentType = element.getAttribute('data-content-type');
          const content = element.getAttribute('data-content');
          
          if (!content) return;
          
          switch (contentType) {
            case 'text/plain': {
              const pre = document.createElement('pre');
              pre.style.whiteSpace = 'pre-wrap';
              pre.style.wordWrap = 'break-word';
              pre.style.fontFamily = 'inherit';
              pre.style.margin = '0';
              pre.textContent = content;
              element.appendChild(pre);
              break;
            }
            case 'text/markdown': {
              const markdownDiv = document.createElement('div');
              // Use the same markdown processing as in the feed
              markdownDiv.innerHTML = generateCommonmarkHtml(DOMPurify.sanitize(content) || '');
              element.appendChild(markdownDiv);
              element.style.display = 'block';
              break;
            }
            default: {
              // For other content types (like images), just display as text
              const para = document.createElement('p');
              para.textContent = content;
              element.appendChild(para);
              break;
            }
          }
        });
      });
    </script>
  </body>
</html>